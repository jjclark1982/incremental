<html>
<head>
    <title>Incremental</title>
    <style>
    sup,sub {
        font-size: 60%;
    }
    </style>
    <script type="text/javascript" id="util">
        $ = document.getElementById.bind(document);
        $$ = document.querySelectorAll.bind(document);
        function request(url, options) {
            options = options || {};
            var xhr = new XMLHttpRequest();
            // standard arguments get treated specially. here are their default values:
            var args = {
                method: 'GET',
                async: true,
                body: null,
                headers: {}
            };
            // any additional options get set directly on xhr.
            // this allows the calling function to specify arbitrary parameters such as 'onload'.
            for (var i in options) {
                if (i in args) {
                    args[i] = options[i];
                }
                else {
                    xhr[i] = options[i];
                }
            }
            // serialize body as JSON unless it is a string
            // TODO: support application/x-www-form-urlencoded
            if (args.body && typeof args.body !== 'string') {
                args.body = JSON.stringify(args.body);
                args.headers['Content-Type'] = 'application/json';
            }
            xhr.open(args.method, url, args.async);
            for (var name in args.headers) {
                var value = args.headers[name];
                xhr.setRequestHeader(name, value);
            }
            xhr.send(args.body);
            return xhr;
        }
        function serializeQuery(obj) {
            var pairs = [];
            for (var key in obj) {
                var value = obj[key];
                pairs.push(encodeURIComponent(key)+'='+encodeURIComponent(value));
            }
            return pairs.join('&').replace(/%20/g, '+')
        }
        function setText(field, value) {
            var props = ['value', 'textContent', 'innerText'];
            for (var i in props) {
                var prop = props[i];
                if (prop in field) {
                    field[prop] = value;
                    return
                }
            }
        }
        function render(template, context) {
            var container = document.createElement('div');
            var templateText = template.innerHTML || template;
            container.innerHTML = templateText.trim();
            var el = container.firstChild;
            for (var key in context) {
                var value = context[key];
                var selector = '[name="'+key+'"]';
                var fields = el.querySelectorAll(selector);
                for (var i = 0; i < fields.length; i++) {
                    var field = fields[i];
                    setText(field, value);
                }
            }
            return el;
        }
    </script>
    <script type="text/html" id="term-template">
        <span class="term">
            <span name="coefficient"></span><var name="variable"></var><sup name="exponent"></sup>
        </span>
    </script>
</head>
<body>
    <div style="position:fixed; top:0.5em; right:0.5em;">
        <span id="fps"></span> FPS
    </div>
    <p style="display:none;">
        Total frames: <span id="totalFrames"></span>
    </p>
    <p>
        Time on this page: <span id="timeOnPage">0</span> sec
    </p>
    <p>
        Clock skew: <span id="serverTime"></span> msec
        <button onclick="updateClockSkew()">update</button>
    </p>
    <p style="display: none;">
        Time since last click: <var>t</var> = <span id="timeSinceClick"></span> sec
        <button id="clickMe">click</button>
        Formula: <var>f</var>(<var>t</var>) = <span id="formula"></span>
        <button id="randomize-formula">randomize</button>
        <br>
        Value of formula: <span id="formula-value"></span>
    </p>
    <p style="line-height: 20px;">
        Accumulator start: <var>t<sub>0</sub></var> = <span id="accumulator-t0"></span>
        <br>
        Accumulator offset: <var>t</var> = <span id="accumulator-t"></span> sec
        <br>
        Accumulator formula: <var>f</var>(<var>t</var>) = <span id="accumulator-formula">0</span>
        <br>
        Accumulator value: <span id="accumulator"></span>
    </p>
    <p>
        <button id="add-one-per-second">Add 1 per second</button>
        <button id="add-one">Add 1</button>
        <button id="reset-accumulator">Reset</button>
    </p>
    <script>
        var clickTime = window.localStorage.getItem('clickTime') || Date.now();
        $('clickMe').onclick = function(){
            var now = Date.now();
            var serverNow = now - skew;
            // actually, we want to make sure skew is valid before using it
            clickTime = serverNow;
            window.localStorage.setItem('clickTime', clickTime);
        }

        var $timeOnPage = $('timeOnPage');
        var $fps = $('fps');
        var $totalFrames = $('totalFrames');
        var $timeSinceClick = $('timeSinceClick');
        var $formulaValue = $('formula-value');
        var startTime = Date.now();
        var lastFrame = startTime;
        var frameCount = 0;
        var totalFrames = 0;
        var targetFPS = 12;
        var msecPerFrame = 1000/targetFPS;
        function tick() {
            var now = Date.now();
            setText($timeOnPage, Math.floor((now - startTime)/1000));
            setText($totalFrames, ++totalFrames);

            var msecForThisFrame = now - lastFrame;
            lastFrame = now;

            msecPerFrame = (0.1 * msecForThisFrame) + (0.9 * msecPerFrame);
            setText($fps, Math.round(1000 / msecPerFrame));

            if (Math.abs(msecForThisFrame) > 1000/targetFPS + 100) {
                console.log('detected clock jump. reloading time from server.', msecForThisFrame);
                updateClockSkew();
            }


            var msecSinceClick = (now - clickTime - skew)
            setText($timeSinceClick, (msecSinceClick/100|0)/10);

            var value = evaluatePolynomial(polynomial, msecSinceClick/1000);
            setText($formulaValue, Math.floor(value));

            var accum_t = (now - accumulator_t0 - skew)/1000;
            var accum_value = evaluatePolynomial(accumulatorPoly, accum_t);
            setText($('accumulator-t'), accum_t);
            setText($('accumulator'), Math.floor(accum_value));
            // requestAnimationFrame(tick);
        }

        var displayInterval = null;
        function setFPS(fps) {
            targetFPS = fps;
            clearInterval(displayInterval);
            displayInterval = setInterval(function(){
                requestAnimationFrame(tick);
            }, 1000/fps);
        }
        setFPS(targetFPS);

        var skew = null;
        function updateClockSkew() {
            skew = null;
            var clientTime = Date.now();
            request(document.location, {
                method: 'HEAD',
                headers: {'Cache-Control': 'no-cache'},
                onload: function(){
                    if (skew != null || this.status == 0) {
                        return
                    }
                    var serverTime = new Date(this.getResponseHeader('date'));
                    skew = (Date.now()+clientTime)/2 - serverTime;
                    setText($('serverTime'), skew);
                }
            });
        };
        updateClockSkew();

        function displayPolynomial(coefficients, el, variable) {
            termTemplate = $('term-template').innerHTML;

            el.innerHTML = '';
            terms = [];
            for (var exp = coefficients.length-1; exp >= 0; exp--) {
                var k = coefficients[exp];
                var context = {};
                if (!k) {
                    continue;
                }
                if (k != 1 || exp == 0) {
                    context.coefficient = k;
                }
                if (exp> 0) {
                    context.variable = variable || 't';
                }
                if (exp> 1) {
                    context.exponent = exp;
                }
                var $term = render(termTemplate, context);
                terms.push($term);
            }
            if (terms.length == 0) {
                terms.push(render('0'));
            }
            for (var i = 0; i < terms.length; i++) {
                var $term = terms[i];
                if (i > 0) {
                    el.appendChild(render('+'));
                }
                el.appendChild($term);
            }
        }
        var polynomial = [];
        function randomizeFormula() {
            polynomial = [];
            for (var i = 0; i < 3; i++) {
                polynomial[i] = Math.random()*10|0;
            }
            displayPolynomial(polynomial, $('formula'));
        }
        $('randomize-formula').onclick = randomizeFormula;
        randomizeFormula();

        function evaluatePolynomial(coefficients, x) {
            var accum = 0;
            var x_to_exp = 1;
            for (var exp = 0; exp < coefficients.length; exp++) {
                var k = coefficients[exp] || 0;
                accum += k * x_to_exp;
                x_to_exp *= x;
            }
            return accum;
        }

        // affine formula from user input
        // general form is f(t) = m*t + b
        //                 where t = t_now - t_0
        // start with m=0, b=0
        // click one button to increment b
        // click another button to increment m:
        //     set b to f(t)
        //     set m to m+1
        //     set t0 to Date.now()
        accumulator_t0 = startTime;
        accumulatorPoly = [];
        try {
            accumulator_t0 = parseInt(localStorage.getItem('accumulator_t0')) || startTime;
            accumulatorPoly = JSON.parse(localStorage.getItem('accumulatorPoly') || []);
        }
        catch (e) {}
        function updateAccumulator() {
            localStorage.setItem('accumulator_t0', accumulator_t0);
            localStorage.setItem('accumulatorPoly', JSON.stringify(accumulatorPoly));
            displayPolynomial(accumulatorPoly, $('accumulator-formula'));
            setText($('accumulator-t0'), new Date(accumulator_t0));
        }
        updateAccumulator();
        $("add-one").onclick = function() {
            accumulatorPoly[0] = (accumulatorPoly[0] || 0) + 1;
            updateAccumulator();
        };
        $("add-one-per-second").onclick = function() {
            // TODO: delay this calculation if skew is not currently valid
            var t1 = Date.now() - skew;
            var t = (t1 - accumulator_t0)/1000;
            var currentValue = evaluatePolynomial(accumulatorPoly, t);
            accumulatorPoly[0] = currentValue;
            accumulator_t0 = t1;
            accumulatorPoly[1] = (accumulatorPoly[1] || 0) + 1;
            updateAccumulator();
        };
        $("reset-accumulator").onclick = function() {
            accumulatorPoly = [];
            updateAccumulator();
        };

    </script>
</body>
