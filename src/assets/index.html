<html>
<head>
    <title>Incremental</title>
    <style>
        body {
            padding: 1em;
            font-family: serif;
        }
    </style>
</head>
<body>
    <div style="position:fixed; top:0.5em; right:0.5em; display: none;">
        <span id="fps"></span> FPS
    </div>
    <p style="display:none;">
        Total frames: <span id="totalFrames"></span>
    </p>
    <p>
        Time on this page: <span id="timeOnPage">0</span> sec
    </p>
    <p>
        Clock skew: <span id="serverTime"></span> msec
        <button onclick="updateClockSkew()">update</button>
    </p>
    <p style="display: none;">
        Time since last click: <var>t</var> = <span id="timeSinceClick"></span> sec
        <button id="clickMe">click</button>
        Formula: <var>f</var>(<var>t</var>) = <span id="formula"></span>
        <button id="randomize-formula">randomize</button>
        <br>
        Value of formula: <span id="formula-value"></span>
    </p>
    <p style="line-height: 20px;">
        Accumulator start: <var>t<sub>0</sub></var> = <span id="accumulator-t0"></span>
        <br>
        Accumulator offset: <var>t</var> = <span id="accumulator-t"></span> sec
        <br>
        Accumulator formula: <var>f</var>(<var>t</var>) = <span id="accumulator-formula">0</span>
        <br>
        Continuous value: <span id="accumulator-value"></span>
        <br>
        Discrete value: <span id="accumulator-value-discrete"></span>
    </p>
    <p>
        <button id="add-one-per-second">Add 1 per second</button>
        <button id="add-one">Add 1</button>
        <button id="reset-accumulator">Reset</button>
    </p>
    <script>
        var clickTime = window.localStorage.getItem('clickTime') || Date.now();
        $('clickMe').onclick = function(){
            var now = Date.now();
            var serverNow = now - skew;
            // actually, we want to make sure skew is valid before using it
            clickTime = serverNow;
            window.localStorage.setItem('clickTime', clickTime);
        }

        var $timeOnPage = $('timeOnPage');
        var $fps = $('fps');
        var $totalFrames = $('totalFrames');
        var $timeSinceClick = $('timeSinceClick');
        var $formulaValue = $('formula-value');
        var startTime = Date.now();
        var lastFrame = startTime;
        var frameCount = 0;
        var totalFrames = 0;
        var targetFPS = 12;
        var msecPerFrame = 1000/targetFPS;
        function tick() {
            var now = Date.now();
            setText($timeOnPage, Math.floor((now - startTime)/1000));
            setText($totalFrames, ++totalFrames);

            var msecForThisFrame = now - lastFrame;
            lastFrame = now;

            msecPerFrame = (0.1 * msecForThisFrame) + (0.9 * msecPerFrame);
            setText($fps, Math.round(1000 / msecPerFrame));

            if (Math.abs(msecForThisFrame) > 1000/targetFPS + 100) {
                console.log('detected clock jump. reloading time from server.', msecForThisFrame);
                updateClockSkew();
            }


            var msecSinceClick = (now - clickTime - skew)
            setText($timeSinceClick, (msecSinceClick/100|0)/10);

            var value = evaluatePolynomial(polynomial, msecSinceClick/1000);
            setText($formulaValue, Math.floor(value));

            var accum_t = (now - accumulator.t_0 - skew)/1000;
            var accum_value = evaluatePolynomial(accumulator.k, accum_t);
            var accum_value_d = accumulator.evaluate(accum_t);
            setText($('accumulator-t'), accum_t);
            setText($('accumulator-value'), Math.floor(accum_value));
            setText($('accumulator-value-discrete'), Math.floor(accum_value_d));
        }

        var displayInterval = null;
        function setFPS(fps) {
            targetFPS = fps;
            clearInterval(displayInterval);
            displayInterval = setInterval(function(){
                requestAnimationFrame(tick);
            }, 1000/fps);
        }
        setFPS(targetFPS);

        var polynomial = [];
        function randomizeFormula() {
            polynomial = [];
            for (var i = 0; i < 3; i++) {
                polynomial[i] = Math.random()*10|0;
            }
            displayPolynomial(polynomial, $('formula'));
        }
        $('randomize-formula').onclick = randomizeFormula;
        randomizeFormula();

        function evaluatePolynomial(coefficients, x) {
            var accum = 0;
            var x_to_exp = 1;
            for (var exp = 0; exp < coefficients.length; exp++) {
                var k_i = coefficients[exp] || 0;
                accum += k_i * x_to_exp;
                x_to_exp *= x;
            }
            return accum;
        }

        function Accumulator(properties) {
            this.trustClientClock = false;
            this.discrete = true;
            this.batched = false;
            this.scale = 1000;
            this.t_0 = Date.now();
            this.k = [];
            for (var i in properties) {
                this[i] = properties[i];
            }
        }

        // number of widgets at time t = edp(poly, t, 0)
        // number of widget factories at time t = edp(poly, t, 1)
        // number of manually-bought factories = poly[1]
        // TODO: do these equivalences still hold after translation?
        Accumulator.prototype.evaluate = function(x, i) {
            i = i || 0;
            if (i >= this.k.length) {
                return 0;
            }
            if (this.batched) {
                x = Math.floor(x);
            }
            var j = i + 1;
            var k_j = this.evaluate(x, j);
            var k_i = this.k[i] + k_j*x;
            if (this.discrete) {
                return Math.floor(k_i);
            }
            else {
                return k_i;
            }
        };

        // general-purpose function to translate a polynomial from t_0 to t_1
        // TODO: determine whether this method can accommodate higher-order polynomials
        // f(t) = a * t^2 + b * t + c
        // f(t-t_0) = a*(t-t_0)^2 + b*(t-t_0) + c
        //          = a*(t^2 - 2*t_0*t + t_0^2) + b*t - b*t_0 + c
        //          = a*t^2 - (2*a*t_0 + b)*t + a*t_0^2 - b*t_0 + c
        // is t_0^2 meaningful?
        Accumulator.prototype.translate = function(t_1) {
            var newPoly = [];
            for (var i = 0; i < this.k.length; i++) {
                // TODO: support higher order translation
                newPoly[i] = this.k[i];
            }
            var t = (t_1-this.t_0)/this.scale;
            newPoly[0] = this.evaluate(t);
            this.k = newPoly;
            this.t_0 = t_1;
        };

        // would like to support negative mods with floors
        // eg consume materials to produce products,
        // without going below zero
        Accumulator.prototype.addPolynomial = function(mod) {
            if (skew == null && !this.trustClientClock) {
                var that = this;
                updateClockSkew(function(){
                    that.addPolynomial(mod);
                });
            }
            else {
                var t_1 = Date.now() - skew;
                this.translate(t_1);
                mod = mod || [];
                for (var i = 0; i < mod.length; i++) {
                    this.k[i] = (this.k[i] || 0) + mod[i];
                }
                // this.save();
            }
        };

        Accumulator.prototype.save = function() {
            // TBD
        };

        var accumulator = new Accumulator();
        try {
            data = JSON.parse(localStorage.getItem('accumulator'));
            accumulator = new Accumulator(data);
        }
        catch (e) {}

        function saveAccumulator() {
            localStorage.setItem('accumulator', JSON.stringify(accumulator));
            displayPolynomial(accumulator.k, $('accumulator-formula'));
            setText($('accumulator-t0'), new Date(accumulator.t_0));
        }
        saveAccumulator();


        $("add-one").onclick = function() {
            accumulator.addPolynomial([1]);
            saveAccumulator();
        };
        $("add-one-per-second").onclick = function() {
            accumulator.addPolynomial([0,1]);
            saveAccumulator();
        };
        $("reset-accumulator").onclick = function() {
            accumulator.t_0 = Date.now() - skew;
            accumulator.poly = [];
            saveAccumulator();
        };

    </script>
    <div id="content"></div>
    <script src="/bundle.js"></script>
</body>
